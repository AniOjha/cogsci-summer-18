<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Final Testing</title>
	<script type="text/javascript" src="paper.js"></script>
	<script type="text/javascript" src="final_engine.js"></script>
	<script type="text/javascript">
		paper.install(window);
		window.onload = function() {
			paper.setup('canvas');

			var behavior1 = new Behavior(7,5,1);
			var behavior2 = new Behavior(7,0,1);			
			
			var origin = new Path.Circle({
					center : view.center.add(new Point(0, -100)),
					radius : 10,
					fillColor : 'yellow'
				});

			var loc = new Locomotion({
				behavior : behavior1,
				velocity : new Point(0,0),
				mass : 1,
				boundingRadius : 25,
				maxForce : 400,
				maxSpeed : 10000,
				shape : new Path.Circle({
					center : view.center,
					radius : 15,
					fillColor : 'red'
				}),
				point : origin.position.add(new Point(-350,0))

			});
			
			var theta = 90;		
			var radToDeg = 3.14/180;
			theta *= radToDeg;

			var move = new Point (-1 * 350 * Math.cos(theta), 350 * Math.sin(theta));

			var obstacle1 = new Locomotion({
				behavior : behavior2,
				velocity : new Point(0,0),
				mass : 1,
				speed : 0,
				boundingRadius : 25,
				maxForce : 400,
				maxSpeed : 10000,
				shape : new Path.Circle({
					center : view.center,
					radius : 15,
					fillColor : 'blue'
				}),
				point : origin.position.add(move)
			});

			var target1 = new Path.Circle({
					center : origin.position.add(350, 0),
					radius : 10,
					fillColor : 'red'
				});

			var target2 = new Path.Circle({
					center : origin.position.subtract(move),
					radius : 10,
					fillColor : 'blue'
				});

			var entities = [];
			entities.push(loc);
			entities.push(obstacle1);


			var persons =[];
			persons.push(loc);
			persons.push(obstacle1);

			var targets =[];
			targets.push(target1);
			targets.push(target2);

			view.onFrame = function(event) {
				
				for (var i = persons.length - 1; i >= 0; i--) {
					var seekForce = persons[i].steeringSeek(targets[i].position);
					var avoidForce = persons[i].steerToAvoidCollisions(entities);
					var fleeForce = persons[i].steeringFlee(targets[i].position);
					var wanderForce = persons[i].steeringWander(event.delta);

					var seekCoeff;
					if(persons[i].behavior.eagerness > 0){			
						seekCoeff = Math.pow(persons[i].behavior.eagerness, 1.75)/25;
					} else {
						seekCoeff = Math.pow((10+persons[i].behavior.eagerness)/10, 1.75)/25;
					}
					var fleeCoeff;
					if(persons[i].behavior.eagerness > 0){
						fleeCoeff = Math.pow(persons[i].behavior.eagerness, 1.75)/25;
					} else {
						fleeCoeff = Math.pow((10+persons[i].behavior.eagerness)/10, 1.75)/25;
					}
					var avoidCoeff = 0.05 * persons[i].behavior.focus;
					var wanderCoeff = 2.5 * (10 - persons[i].behavior.focus);

					seekForce = seekForce.multiply(seekCoeff);
					fleeForce = fleeForce.multiply(fleeCoeff);
					avoidForce = avoidForce.multiply(avoidCoeff);
					wanderForce = wanderForce.multiply(wanderCoeff);

					var dist = persons[i].position.subtract(targets[i].position).length;

					if (dist > 100) {											//decide parameter to judge whether to flee or to seek
						if(persons[i].behavior.eagerness > 0) {							//just seeking right now
							var netForce = seekForce;		//paramatrize
							if(persons[i].behavior.focus > 5) {
								//console.log("Avoid");
								netForce = netForce.add(avoidForce.add(wanderForce));
							} else {
								netForce = netForce.add(avoidForce.multiply((persons[i].behavior.focus)/10));
								netForce = netForce.add(wanderForce.add(seekForce.multiply(-0.05 * (10 - persons[i].behavior.focus) * seekCoeff)));							
							}
							persons[i].steer(netForce, event.delta,event.count);
						} else {
							var netForce = seekForce.add(avoidForce.add(wanderForce));
							persons[i].steer(netForce, event.delta,event.count);
						}
					} else if(dist > 0){						// should be : dist > 2.1 * RAD
						persons[i].steer(seekForce,event.delta,event.count);
					} else {
						// put condition to stop if the dot is too close to target
					}

				}
			}
		}
	</script>
</head>
<body>
	<canvas id="canvas" width="960" height="960"></canvas>
</body>
</html>