<!DOCTYPE html>
<html>
<head>
	{% load static %}
	<meta charset="utf-8">
	<title>{{ title }}</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script type="text/javascript" src="http://dsambrano.com/demos/paper.js"></script>
    <script type="text/javascript">
    	var parray = [];
var interactions = null;
function Behavior(params) {
	this.eagerness = params.eagerness;
	this.arousal = params.arousal;
	this.focus = params.focus;
	this.vibrate = function(basis,mean,count) {
		// if(basis.length <= 1) {
		// 	var ran = new Point.random();
		// 	basis = ran;
		// } else {
		// 	basis = basis.normalize();
		// }
		if (this.arousal > 0 && ((2 * count) % 3)) {
			var	vibrationvec = basis.multiply(Math.random() * this.vibrationAmplitude());
			return vibrationvec;
		} else {
			return new Point(0,0);
		}
	}
	this.vibrationAmplitude = function() {
		return this.arousal * 3.5;
	}
	this.wanderSpeed = function(dt) {
		// return 0.5 * Math.pow((10 - this.focus),1.3) * (60*dt);
		console.log("FOC "+this.focus);

		return 10 - this.focus;
	}
	this.wanderMagnitude = function() {
		return 100;
	}
	this.visionAngle = function() {
		return 15 * this.focus;
	}
	this.minDistance = function() {
		return 30;
	}
	this.threat = function() {
		return false;
	}
	this.pspace = function() {
		return 30;
	}
	this.minInteractionDistance = function() {
		return 150;
	}
	this.minTimeUntilCollision = function() {
		return 40;
	}
	this.getSeekCoefficient = function() {
		var seekCoeff;
		if(this.eagerness > 0){			
			seekCoeff = Math.pow(this.eagerness, 1.75)/3;
		} else {
			seekCoeff = Math.pow((10+this.eagerness)/10, 1.75)/3;
		}
		return seekCoeff;
	}
	this.getFleeCoefficient = function()  {
		var fleeCoeff;
		if(this.eagerness > 0){
			fleeCoeff = Math.pow(this.eagerness, 1.75)/30;
		} else {
			fleeCoeff = Math.pow((10+this.eagerness)/10, 1.75)/30;
		}
		return fleeCoeff;
	}
	this.getAvoidCoefficient = function() {
		return 0.03 * this.focus;
	}
	this.getWanderCoefficient = function() {
		return 8 * (10 - this.focus);
	}
}
function Locomotion(params) {
	this.behavior = params.behavior;
	this.shape = params.shape;
	this.mass = params.mass;
	this.velocity = params.velocity;
	this.speed = params.velocity.length;
	this.maxForce = params.maxForce;
	this.maxSpeed = params.maxSpeed;
	this.shape.position = new Point(params.point.x,params.point.y);
	this.position = this.shape.position;
	this.mean = new Point(this.position.x,this.position.y);
	this._wander_side = 0;
	this._wander_up = 0;
	this.basisParallel = this.velocity.normalize(); 
	this.basisPerpendicular = this.basisParallel.rotate(90);
	this._adjustForce = function(force,dt) {
		var maxAdjSpeed = this.maxSpeed * 0.2;
		if (this.velocity.length > maxAdjSpeed || force.length == 0) {
			return force;
		} else {
			var range = this.velocity.length/maxAdjSpeed;
			var cosine = scalar_interpolation(1.0,-1.0,Math.pow(range,20));
			return limit_max_deviation(force,cosine,this.basisParallel);
		}
	}
	this.steer = function(force,dt,count) {
		var acc = force.divide(this.mass);
		this.velocity = clip_length(this.velocity.add(acc.multiply(dt)),this.maxSpeed);
		this.speed = this.velocity.length;
		this.position = this.position.add(this.velocity.multiply(dt));
		this.basisParallel = this.velocity.normalize();
		this.basisPerpendicular = this.basisParallel.rotate(90);
		this.mean.x = this.position.x;
		this.mean.y = this.position.y;
		var par = 0;
		var perp = 10;

		var temp = this.mean.add(this.behavior.vibrate(this.basisPerpendicular.multiply(perp/10).add(this.basisParallel.multiply(par/10)),this.mean,count));
		this.shape.position = temp.add(this.steeringWander(dt,count));
	}

	this.getBasisPerpendicular = function() {
		if (this.basisPerpendicular.length < 1) {
			return new Point(0,-1);
		} else {
			return this.basisPerpendicular;
		}
	}
	this.getBasisParallel = function() {
		if (this.basisParallel.length < 1) {
			return new Point(1,0);
		} else {
			return this.basisParallel;
		}
	}
	this.futurePosition = function(time) {
		return this.position.add(this.velocity.multiply(time));
	}
	this.steeringWander = function(dt,count) {
		var wanderRate = this.behavior.wanderSpeed(dt);
		// if(this.velocity.length < 1)
		// 	wanderRate = wanderRate * this.velocity.length;
		// var wanderStrength = this.behavior.wanderMagnitude();
		// var displacement = random_vector(wanderRate);
		var wander = this.basisPerpendicular.multiply(Math.cos(count/2)*wanderRate);
		console.log("Wandering by "+wander);
		return wander;
	}
	this.steeringSeek = function(target) {
		var desire = target.subtract(this.position);
		return (desire.subtract(this.velocity)).normalize().multiply(this.maxForce);
	}
	this.steeringFlee = function(target) {
		var desire = this.position.subtract(this.target);
		return (desire.subtract(this.velocity)).normalize().multiply(this.maxForce);
	}
	this.predictNearestApproachTime = function(other) {		
		var relative = other.velocity.subtract(this.velocity);
		var relativeSpeed = relative.length;
		if(relativeSpeed == 0){
			return 0;
		}
		var tanget = relative.normalize();
		var pos = this.position.subtract(other.position);
		var projection = tanget.dot(pos);
		return projection/relativeSpeed;
	}
	this.predictNearestApproachPosition = function(other,time) {
		var mytravel = this.velocity.multiply(time);
		var othertravel = other.velocity.multiply(time);
		var myfinal = this.position.add(mytravel);
		var otherfinal = other.shape.position.add(othertravel);
		return vector_distance(myfinal, otherfinal);
	}
	this.predictsloworfast = function(other,time) {
		var mytravel = this.velocity.multiply(time);
		var othertravel = other.velocity.multiply(time);
		var myfinal = this.position.add(mytravel);
		var otherfinal = other.shape.position.add(othertravel);
		fast = ((this.velocity.dot(myfinal.subtract(otherfinal)))>=0) ? 1:-1;
		return fast;
	}
	this.checkInCone = function(object) {
		var degToRad = 3.14/180;
		var halfangle = this.behavior.visionAngle() * degToRad; // PARAMETERISE
		var cus = Math.cos(halfangle);
		var line = object.shape.position.subtract(this.position);
		var direction = this.velocity.normalize;
		var ang = line.dot(direction);
		return (ang > cus);
	}
	this.steeringEvasion = function(other,maxpred) {
		var offset = this.position.subtract(other.position);
		var distance = offset.length;
		var roughtime = distance/other.speed;
		var predtime = roughtime;
		if (predtime > maxpred) {
			predtime = maxpred;
		}
		var target = other.futurePosition(predtime);
		return this.steeringFlee(target);
	}
	this.steeringPursuit = function(other,maxpred) {
		var offset = other.position.subtract(this.position);
		var distance = offset.length;
		var unitOffset = offset.normalize();
		var parallelness = this.basisParallel.dot(other.basisParallel);
		var forwardness = this.basisParallel.dot(unitOffset);
		var directTravelTime = distance/this.speed;
		var f = intervalComparison(forwardness,-0.707,+0.707);
		var p = intervalComparison(parallelness,-0.707,+0.707);
		var timeFactor = 0;
		switch (f)	{
    		case +1:
        		switch (p)
        		{
        			case +1:          // ahead, parallel
            			timeFactor = 4;
            			break;
        			case 0:           // ahead, perpendicular
            			timeFactor = 1.8;
            			break;
        			case -1:          // ahead, anti-parallel
            			timeFactor = 0.85;
            			break;
        		}
        		break;
    		case 0:
        		switch (p)
        		{
        			case +1:          // aside, parallel
            			timeFactor = 1;
            			break;
        			case 0:           // aside, perpendicular
            			timeFactor = 0.8;
            			break;
        			case -1:          // aside, anti-parallel
            			timeFactor = 4;
            			break;
        		}
        		break;
    		case -1:
        		switch (p)
        		{
        			case +1:          // behind, parallel
            			timeFactor = 0.5;
            			break;
        			case 0:           // behind, perpendicular
            			timeFactor = 2;
            			break;
        			case -1:          // behind, anti-parallel
            			timeFactor = 2;
            			break;
        		}
        	break;
    	}
    	var et = directTravelTime * timeFactor;
    	var etl = et;
    	if (etl > maxpred) {
    		etl = maxpred;
    	}
    	var target = other.futurePosition(etl);
    	return this.steeringSeek(target);
	}
	this.steerToAvoidCollisions = function() {
		if(parray.length) {
			var minSeparation = this.behavior.minDistance(); //PARAMETERISE
			for(var i=0; i<parray.length; i++) {
				if(parray[i]!=this){
					if(this.checkInCone(parray[i])) {
						var dist = this.shape.position.subtract(parray[i].shape.position);
						if(dist.length < minSeparation) {
							var vy = this.basisPerpendicular;
							var projn = dist.dot(vy);
							projn = (projn >= 0) ? 1:-1;
							return (vy.normalize()).multiply(20*projn*this.maxForce).add(this.velocity.normalize().multiply(-10*this.maxForce));
						}
					}
				}
			}
			var threat = this.behavior.threat();
			var pspace = this.behavior.pspace();
			var mintimeuntilcollision = this.behavior.minTimeUntilCollision();			//tune these
			var time, mintime = mintimeuntilcollision;
			var index = 0;
			for(var i=0; i<parray.length; i++) {
				if(parray[i]!=this){
					if(this.checkInCone(parray[i])) {
						time = this.predictNearestApproachTime(parray[i]);
						if(time >= 0 && time < mintime) {
							var mindist = this.predictNearestApproachPosition(parray[i], time);
					
							if(mindist < pspace) {
								console.log("Three close");
								mintime = time;
								threat = true;
								index = i;
							}
						}
					}
				}
			} 
			if(threat) {
				var obstacle = parray[index];
				var mindist = this.predictNearestApproachPosition(obstacle, mintime);
				var dist =(obstacle.position.subtract(this.position)).length
				var obs_future = obstacle.position.add(obstacle.velocity.multiply(mintime));
				var my_future = this.position.add(this.velocity.multiply(mintime));
				var my_unit = this.velocity.normalize();
				var my_side = my_unit.rotate(90);
				var obs_unit = obstacle.velocity.normalize();
				var parallelness = my_unit.dot(obs_unit);
        		var angle = 0.707, steer = 0;
        		if (parallelness < -1*angle)
        		{
            		var offset = obs_future.subtract(this.position);
            		var sideDot = offset.dot(my_side);
            	    steer = (sideDot >= 0) ? -3:3;
        		}
        		else
        		{
            		if (parallelness > angle)
            		{
                		offset = obstacle.position.subtract(this.position);
            			sideDot = offset.dot(my_side);
            			steer = (sideDot >= 0) ? -1 : 1;
            		}
            		else
            		{
                		if (obstacle.velocity.length <= this.velocity.length)
		                {	
                    		sideDot = my_side.dot(obstacle.velocity);
                    		steer = (sideDot >= 0) ? -1 : 1;
 
                		}
            		}
        		}
        		var fast = this.predictsloworfast(obstacle,mintime);
               	return(((my_side.multiply(steer)).multiply(5*this.maxForce)).add(this.velocity.normalize().multiply(fast*this.maxForce))).normalize().multiply(10*this.maxForce);
			} else {
				return new Point(0,0);
			}
		} else {
			return new Point(0,0);
		}
	}

	//Make externally sure that boid is never equal to this
	this.inBoidNeighborhood = function(boid,mindist,maxdist,maxcos) {
		if (boid == this) {
			return false;
		}
		var offset = boid.position.subtract(this.position);
		var dist = offset.length;
		//offset = offset.normalize();
		if (dist < mindist) {
			return true;
		} 
		if (dist > maxdist) {
			return false;
		}
		offset = offset.normalize();
		forwardness = this.basisParallel.dot(offset);
		return forwardness > maxcos;
	}

	this.steeringSeparation = function(mindist,maxdist,maxcos) {
		var steering = new Point(0,0);
		var offset,distsq;
		for (var i = parray.length - 1; i >= 0; i--) {
			if(parray[i] !== this && this.inBoidNeighborhood(parray[i],mindist,maxdist,maxcos)) {
				offset = this.position.subtract(parray[i].position);
				distsq = offset.dot(offset);
				steering = steering.add(offset.divide(distsq));
			}
		}
		return steering.normalize();
	}

	this.steeringAlignment = function(mindist,maxdist,maxcos) {
		var steering = new Point(0,0);
		var boids = 0;
		for (var i = parray.length - 1; i >= 0; i--) {
			if(parray[i] !== this && this.inBoidNeighborhood(parray[i],mindist,maxdist,maxcos)) {
				steering = steering.add(parray[i].basisParallel);
				boids++;
			}
		}
		if (boids > 0) {
			steering = steering.divide(boids);
			steering = steering.subtract(this.basisParallel);
			steering = steering.normalize();
		}
		return steering;
	}

	this.steeringCohesion = function(mindist,maxdist,maxcos) {
		var steering = new Point(0,0);
		var boids = 0;
		for (var i = parray.length - 1; i >= 0; i--) {
			if(parray[i] !== this && this.inBoidNeighborhood(parray[i],mindist,maxdist,maxcos)) {
				steering = steering.add(parray[i].position);
				boids++;
			}
		}
		if (boids > 0) {
			steering = steering.divide(boids);
			steering = steering.subtract(this.position);
			steering = steering.normalize();
		}
		return steering;
	}

	this.getAveragePoint = function(mindist,maxdist,maxcos) {
		var pt = new Point(0,0);
		var boids = 0;
		for (var i = parray.length - 1; i >= 0; i--) {
			if(parray[i] !== this && this.inBoidNeighborhood(parray[i],mindist,maxdist,maxcos)) {
				pt = pt.add(parray[i].position);
				boids++;
			}
		}
		if (boids > 0) {
			pt = pt.divide(boids);
		}
		return pt;
	}
}

function Interaction(after_behavior,priority) {
	var self = this;
	this.loco = null;
	this.person = null;
	this.layers = [];
	this.currentLayer = 0;
	this.after_behavior = after_behavior;
	this.priority = priority;

	this.setPerson = function(person) {
		this.person = person;
		this.loco = person.loco;
	}

	this.Layer = function(params) {
		this.behavior = params.behavior;
		if ('mindist' in params) {
			this.type = 'distance';
			this.mindist = params.mindist;
		} else if ('time' in  params) {
			this.type = 'time';
			this.time = params.time;
		}
		if('avoid_context' in params)
			this.avoid_context = params.avoid_context;
		if('seek_context' in params)
			this.seek_context = params.seek_context;
		if('flee_context' in params)
			this.flee_context = params.flee_context;
		if('wander_context' in params)	
			this.wander_context = params.wander_context;
		if ('target' in params) {
			this.target = params.target;
			if ('moving' in params) {
				this.moving = params.moving;
				this.predictTime = params.predictTime;
			} else {
				this.moving = false;
			}
		} else {
			this.target = null;
		}

		this.runLayer = function(dt) {
			if (this.type === 'distance') {
				if (this.target != null) {
					var dist;
					if (this.moving == false) {
						dist =  self.loco.position.subtract(this.target).length;	
					} else {
						dist = self.loco.position.subtract(this.target.position).length;
					}
					if (dist <= this.mindist) {
						self.updateLayer();
						return new Point(0,0);
					}
				} else {
					self.updateLayer();
					return new Point(0,0);
				}
			} else {
				if (this.time == 0) {
					self.updateLayer();
					return new Point(0,0);
				}
				this.time--;
			}
			var netForce = new Point(0,0);
			if (this.target != null && this.seek_context != null && this.seek_context != 0) {
				var b1 = self.person.behavior.getSeekCoefficient();
				var seekForce;
				if (this.moving == false) {
					seekForce = self.loco.steeringSeek(this.target).multiply(b1 * this.seek_context);
				} else {
					seekForce = self.loco.steeringPursuit(this.target,this.predictTime).multiply(b1 * this.seek_context);
				}
				netForce = netForce.add(seekForce);
			}
			if (this.target != null && this.flee_context != null && this.flee_context != 0) {
				var b2 = self.person.behavior.getSeekCoefficient();
				var fleeForce;
				if (this.moving == false) {
					fleeForce = self.loco.steeringFlee(this.target).multiply(b2 * this.flee_context);
				} else {
					fleeForce = self.loco.steeringEvasion(this.target,this.predictTime).multiply(b2 * this.flee_context);
				}
				netForce = netForce.add(fleeForce);
			}
			if (parray != null && parray.length > 0 && this.avoid_context != null && this.avoid_context != 0) {
				var b3 = self.person.behavior.getAvoidCoefficient();
				var avoidForce = self.loco.steerToAvoidCollisions().multiply(b3 * this.avoid_context);
				netForce = netForce.add(avoidForce);
			}
			if (this.wander_context != null && this.wander_context != 0) {
				var b4 = self.person.behavior.getWanderCoefficient();
				var wanderForce = self.loco.steeringWander(dt).multiply(0 * this.wander_context);
				netForce = netForce.add(wanderForce);
			}
			return netForce;
		}
	}

	this.updateLayer = function() {
		this.currentLayer++;
		if (this.person.pid == 1) {
			console.log("Currentlayer is now " + this.currentLayer);
		}
		this.loco.velocity = new Point(0,0);
		if (this.active()) {
			this.person.setBehavior(this.layers[this.currentLayer].behavior);
		} else if (this.currentLayer == this.layers.length) {
			console.log("layers over "+this.currentLayer)
			if (this.after_behavior != null) {
				this.person.setBehavior(this.after_behavior);
			}
		}
	}

	this.addLayer = function(params) {
		this.layers.push(new this.Layer(params));
	}

	this.active = function() {
		return (this.currentLayer < this.layers.length);
	}

	this.run = function(dt) {
		if (this.active()) {
			return ((this.layers[this.currentLayer]).runLayer(dt));
		}
	}
} 

function LocalInteraction(interaction,point,loco) {
	this.interaction = interaction;
	this.point = point;
	this.loco = loco;
	this.getpoint = function() {
		if (this.point != null) {
			return this.point;
		} else {
			return this.loco.position;
		}
	}
}

function Person(pid,params) {
	this.loco = params.loco;
	this.behavior = this.loco.behavior;
	this.longterm_goal = params.longterm_goal;
	this.longterm_goal.setPerson(this);
	this.pid = pid;

	this.setBehavior = function(behavior) {
		this.loco.behavior = behavior;
		this.behavior = behavior;
	}
	
	this.action_select = function(event) {
		if (interactions == null) {
			return this.longterm_goal;
		} else {
			console.log("At least checking");
			var actions = [];
			for (var i = interactions[this.pid-1].length - 1; i >= 0; i--) {
				var act = interactions[this.pid-1][i];
				if (act != null && act.interaction.active()) {
					actions.push(act);
				} else if(act != null && act.interaction.active() == false) {
					interactions[this.pid-1][i] = null;
				}
			}

			var min = 0;
			if (actions[min] == null) {
				return this.longterm_goal;
			}

			var interactionDist = this.behavior.minInteractionDistance();
			var dist;
			for (var i = 1; i < actions.length; i++) {
				dist = this.loco.position.subtract(actions[i].getpoint()).length;
				if (actions[i]!=this && actions[i].interaction.priority > actions[min].interaction.priority && dist <= interactionDist && actions[i].interaction.active()) {
					min = i;
				} else if (actions[i]!=this && actions[i].interaction.priority == actions[min].interaction.priority && dist <= interactionDist && dist < this.loco.position.subtract(actions[min].getpoint()).length  && actions[i].interaction.active()) {
					min = i;
				}
			}
			if (actions[min] == null) {
				return this.longterm_goal;
			}
			dist = this.loco.position.subtract(actions[min].getpoint()).length;
			var checkr = actions[min].getpoint();
			if(this.pid == 1) console.log(checkr+" dist "+this.loco.position + " "+ dist);
			if (dist > interactionDist) {
				return this.longterm_goal;
			} 

			if (actions[min].interaction.priority > this.longterm_goal.priority && actions[min].interaction.active()) {
				actions[min].interaction.setPerson(this);
				var layer = actions[min].interaction.currentLayer;
				var behavior = actions[min].interaction.layers[layer].behavior;
				//console.log(behavior);
				this.setBehavior(behavior);
				//this.loco.velocity = new Point(0,0);
				actions[min].interaction.setPerson(this);
				console.log("SUcc")
				return actions[min].interaction;
			} else {
				return this.longterm_goal;
			}
		}
	}

	this.run = function(event) {
		var goal = this.action_select(event);
		if (goal.active()) {
			var force = goal.run(event.delta);
			//console.log(force);
			this.loco.steer(force,event.delta,event.count);
		}
	}
}


function random_vector(mag) {
	var randomx = Math.random();
	var randomy = Math.random();
	var maxAngle = 2 * Math.PI;
	var dx = Math.cos(randomx * maxAngle);
	var dy = Math.cos(randomy * maxAngle);
	var rand_vec = new Point(dx,dy);
	rand_vec = rand_vec.normalize();
	return rand_vec.multiply(mag);	
}

function vector_distance(vec1,vec2) {
	var res = vec1.subtract(vec2);
	return res.length;
}

function scalar_random_walk(initial,walkspeed,min,max) {
	var next = initial + rand_range(-1*walkspeed,walkspeed);
	if (next < min) {
		return min;
	}
	if (next > max) {
		return max;
	}
	return next;
}

//Utility functions for various math ops
function limit_max_deviation(force,conecos,basis) {
	if (force.length == 0) {
		return force;
	}
	var sourcecos = basis.dot(force.normalize());
	if (sourcecos >= conecos) {
		return force;
	}
	var perp = force.subtract(basis.multiply(basis.dot(force)));
	var unitperp = perp.normalize();
	var perpDist = Math.sqrt(1 - (conecos * conecos));
	var c0 = basis.multiply(conecos);
	var c1 = unitperp.multiply(perpDist);
	return c0.add(c1).multiply(force.length);
}

function scalar_interpolation(x1,x2,t) {
	return x1 + ((x2 - x1) * t);
}

function vector_interpolation(v1,v2,t) {
	var dif = v2.subtract(v1);
	dif = dif.multiply(t);
	return v1.add(dif);
}

function blend_vec(t,newvec,smooth) {
	return vector_interpolation(smooth,newvec,clip_value(t,0,1))
}

function clip_value(val,min,max) {
	if (val < min) {
		return min;
	} else if (val > max) {
		return max;
	} else {
		return val;
	}
}

function  rand_range(min,max) {
	return min + Math.random() * (max - min);
}

function clip_length(vec,len) {
	if (vec.length > len) {
		return vec.normalize().multiply(len);
	} else {
		return vec;
	}
}

function intervalComparison(x,lower,upper) {
	if (x < lower) {
		return -1;
	}
	if (x > upper) {
		return 1;
	}
	return 0;
}
    </script>
    
    	<script type="text/javascript">
		paper.install(window);
		window.onload = function() {
			paper.setup('experiment');

			var output = {
				scene1 : {
	            		expid: -1,
	            		name: "N/A",
	            		roll: -1,
	            		age: -1,
	            		gender: -1,
	            		happy1: -1,
	            		sad1: -1,
	            		fearful1: -1,
	            		angry1: -1,
	            		surprised1: -1
				},
				scene2 : {
						expid: -1,
	            		name: "N/A",
	            		roll: -1,
	            		age: -1,
	            		gender: -1,
	            		happy2: -1,
	            		sad2: -1,
	            		fearful2: -1,
	            		angry2: -1,
	            		surprised2: -1
				},
				scene3 : {
						expid: -1,
	            		name: "N/A",
	            		roll: -1,
	            		age: -1,
	            		gender: -1,
	            		happy3: -1,
	            		sad3: -1,
	            		fearful3: -1,
	            		angry3: -1,
	            		surprised3: -1
				}
			};
			var activated = true;
			var scene = 1;
			var time1;
			var time2;

			var behavior1 = new Behavior({			// Person 1 
				eagerness : 5,
				arousal : 0,
				focus : 1
			});
			var behavior2 = new Behavior({			// Person 2 
				eagerness : 1,
				arousal : 1,
				focus : 10
			});
			
			
			var loco1 = new Locomotion({			// Person 1
				behavior : behavior1,
				velocity : new Point(0,0),
				mass : 1,
				boundingRadius : 25,
				maxForce : 400,
				maxSpeed : 100,
				shape : new Path.Circle({
					center : view.center,
					radius : 15,
					fillColor : 'blue'
				}),
				point : view.center.add(new Point(-200,150))
			});

			var loco2 = new Locomotion({			// Person 2
				behavior : behavior1,
				velocity : new Point(0,0),
				mass : 1,
				boundingRadius : 25,
				maxForce : 400,
				maxSpeed : 100,
				shape : new Path.Circle({
					center : view.center,
					radius : 15,
					fillColor : 'red'
				}),
				point : view.center.add(new Point(-200,-160))
			});

			var tar = view.center.add(new Point(-200,-5));
			
			var longterm_goals1 = new Interaction(behavior1,10);		
			longterm_goals1.addLayer({
				behavior : behavior1,
				target : view.center.add(new Point(-200,-160)), 
				seek_context : 1,
				mindist : 25
			});
			
			var longterm_goals2 = new Interaction(behavior1,10);		
			longterm_goals2.addLayer({
				behavior : behavior1,
				target : view.center.add(new Point(-200,150)),
				seek_context : 1,
				mindist : 25
			});

			var person1 = new Person(1,{
				loco : loco1,
				longterm_goal : longterm_goals1
			});
			var person2 = new Person(2,{
				loco : loco2,
				longterm_goal : longterm_goals2
			});
						
			parray.push(person1.loco);
			parray.push(person2.loco);

			var interaction12 = new Interaction(behavior1,100);				
			interaction12.addLayer({
				behavior : behavior2,
				target : tar.add(10,0),
				seek_context : 1,
				time : 7 * 60
			});	

			var interaction21 = new Interaction(behavior1,100);				
			interaction21.addLayer({
				behavior : behavior2,
				target : tar.add(-10,0),
				seek_context : 1,
				time : 7 * 60
			});	

			interactions = new Array(2);
			for (var i = interactions.length - 1; i >= 0; i--) {
				interactions[i] = new Array(2);
				for (var j = interactions[i].length - 1; j >= 0; j--) {
					interactions[i][j] = null;
				}
			}

			interactions[0][1] = new LocalInteraction(interaction12,null,person2.loco);
			interactions[1][0] = new LocalInteraction(interaction21,null,person1.loco);

            $('#pop1').hide();
            $('#pop2').hide();
            $('#pop3').hide();

         //    $("#button1").click( function()
         //   		{
         //   			scene = 2;
	        //      	activated = true;
	        //      	$('#pop1').hide();
	        //      	time1 = 400;
         //   		}
        	// );

        	// $("#button2").click( function()
         //   		{
         //   			scene = 3;
	        //      	activated = true;
	        //      	$('#pop2').hide();
	        //      	time2 = 375;
         //   		}
        	// );

        	// $("#button3").click( function()
         //   		{
         //   			scene = 0;
	        //      	activated = true;
	        //      	$('#pop3').hide();
         //   		}
        	// );

        	$('#form1').on('submit', function(e) {
    			e.preventDefault();
		    	// e.stopPropagation();
		    	$("#scene").html("<h4>Scene 2/3<\h4>");
	            
	            output['scene1']['expid'] = $('#expid').val();
	            output['scene1']['name'] = $('#name').val();
	            output['scene1']['roll'] = $('#roll').val();
	            output['scene1']['age']  = $('#age').val();
	            output['scene1']['gender'] = $('#gender').val();
	            output['scene1']['happy1'] = $("input[name='happy1']:checked").val();
	            output['scene1']['sad1'] = $("input[name='sad1']:checked").val();
	            output['scene1']['fearful1'] = $("input[name='fearful1']:checked").val();
	            output['scene1']['surprised1'] = $("input[name='surprised1']:checked").val();
	            output['scene1']['angry1'] = $("input[name='angry1']:checked").val();

	            // $.ajax({
	            // 	type: 'POST',
	            // 	url: '/form2_1/',    //alt : http://localhost:8000
	            // 	data:{
	            // 		expid: $('#expid').val(),
	            // 		name: $('#name').val(),
	            // 		roll: $('#roll').val(),
	            // 		age: $('#age').val(),
	            // 		gender: $('#gender').val(),
	            // 		happy1: $("input[name='happy1']:checked").val(),
	            // 		sad1: $("input[name='sad1']:checked").val(),
	            // 		fearful1: $("input[name='fearful1']:checked").val(),
	            // 		angry1: $("input[name='angry1']:checked").val(),
	            // 		surprised1: $("input[name='surprised1']:checked").val(),
	            // 	},
	            // 	success: function(data){
	            // 		//alert($('#happy1').val()+"is the root of all evil");
	            		scene = 2;
	         	   		activated = true;
	            		$('#pop1').hide();
	            		time1 = 250;
	            // 	},
	            // 	error: function(xhr,status,error){
	            // 		alert(error);
	            // 	}
	            // })

		    });

		    $('#form2').on('submit', function(e) {
    			e.preventDefault();
		    	e.stopPropagation();
		    	$("#scene").html("<h4>Scene 3/3<\h4>");
		    	
		    	output['scene2']['expid'] = $('#expid').val();
	            output['scene2']['name'] = $('#name').val();
	            output['scene2']['roll'] = $('#roll').val();
	            output['scene2']['age']  = $('#age').val();
	            output['scene2']['gender'] = $('#gender').val();
	            output['scene2']['happy2'] = $("input[name='happy2']:checked").val();
	            output['scene2']['sad2'] = $("input[name='sad2']:checked").val();
	            output['scene2']['fearful2'] = $("input[name='fearful2']:checked").val();
	            output['scene2']['surprised2'] = $("input[name='surprised2']:checked").val();
	            output['scene2']['angry2'] = $("input[name='angry2']:checked").val();

	            //  $.ajax({
	            // 	type: 'POST',
	            // 	url: '/form2_2/',    //alt : http://localhost:8000
	            // 	data:{
	            // 		expid: $('#expid').val(),
	            // 		name: $('#name').val(),
	            // 		roll: $('#roll').val(),
	            // 		age: $('#age').val(),
	            // 		gender: $('#gender').val(),
	            // 		happy2: $("input[name='happy2']:checked").val(),
	            // 		sad2: $("input[name='sad2']:checked").val(),
	            // 		fearful2: $("input[name='fearful2']:checked").val(),
	            // 		angry2: $("input[name='angry2']:checked").val(),
	            // 		surprised2: $("input[name='surprised2']:checked").val(),
	            // 	},
	            // 	success: function(data){
	            // 		console.log("E2 done");
	            		scene = 3;
	             		activated = true;
	             		$('#pop2').hide();
	             		time2 = 375;
	            // 	},
	            // 	error: function(xhr,status,error){
	            // 		alert(error);
	            // 	}
	            // })
		    });

		    $('#form3').on('submit', function(e) {
    			// e.preventDefault();
		    	e.stopPropagation();
		    	
		    	output['scene3']['expid'] = $('#expid').val();
	            output['scene3']['name'] = $('#name').val();
	            output['scene3']['roll'] = $('#roll').val();
	            output['scene3']['age']  = $('#age').val();
	            output['scene3']['gender'] = $('#gender').val();
	            output['scene3']['happy3'] = $("input[name='happy3']:checked").val();
	            output['scene3']['sad3'] = $("input[name='sad3']:checked").val();
	            output['scene3']['fearful3'] = $("input[name='fearful3']:checked").val();
	            output['scene3']['surprised3'] = $("input[name='surprised3']:checked").val();
	            output['scene3']['angry3'] = $("input[name='angry3']:checked").val();
	            // alert(JSON.stringify(output))
				
				$("#form3").append("<input type='hidden' name='data' value='"+JSON.stringify(output)+"'>")
	            //  $.ajax({
	            // 	type: 'POST',
	            // 	url: '/form2_2/',    //alt : http://localhost:8000
	            // 	data:{
	            // 		expid: $('#expid').val(),
	            // 		name: $('#name').val(),
	            // 		roll: $('#roll').val(),
	            // 		age: $('#age').val(),
	            // 		gender: $('#gender').val(),
	            // 		happy2: $("input[name='happy2']:checked").val(),
	            // 		sad2: $("input[name='sad2']:checked").val(),
	            // 		fearful2: $("input[name='fearful2']:checked").val(),
	            // 		angry2: $("input[name='angry2']:checked").val(),
	            // 		surprised2: $("input[name='surprised2']:checked").val(),
	            // 	},
	            // 	success: function(data){
	            // 		console.log("E2 done");
	            		scene = 3;
	             		activated = true;
	             		$('#pop2').hide();
	             		time2 = 375;
	            // 	},
	            // 	error: function(xhr,status,error){
	            // 		alert(error);
	            // 	}
	            // })
		    });

			view.onFrame = function(event) {
				if(person2.loco.shape.position.subtract(person1.loco.shape.position).length < 200 && scene == 1){
					activated = false;
					console.log("Main yahan1")
		    		$("#scene").html("<h3><u>Paused</u></h3>");
					$(document).ready(function(){
					       $('#pop1').show();
					});
				}
				if(scene==2 && time1-- < 0){
					activated = false;
					console.log("Main yahan2")					
		    		$("#scene").html("<h3><u>Paused</u></h3>");
					$(document).ready(function(){
					       $('#pop2').show();
					});
				}

				if(scene==3 && person2.loco.shape.position.subtract(person1.loco.shape.position).length > 675){
					activated = false;
		    		$("#scene").html("<h3><u>Paused</u></h3>");
					$(document).ready(function(){
					       $('#pop3').show();
					});
				}


				if(activated){
					person1.run(event);
					person2.run(event);		
				}
			}
		}
	</script>

</head>
<body>
	<div class="text-center">
		<h2>{{ title }}</h2>
	</div>
	<div class="text-center" id="scene"><h4>Scene 1/3</h4></div>
	<canvas id="experiment" width="2000" height="400"></canvas>

	<div id="pop1">
	<div class="container text-center">
			<h3>{{ question }}</h3>
			<div class="row">
	  			<div class="col-xs-4"></div>
	  			<div class="col-xs-1">Not at all</div>
	  			<div class="col-xs-3"></div>
	  			<div class="col-xs-1">Maybe</div>
	  			<div class="col-xs-2"></div>
	  			<div class="col-xs-1">Dominant emotion</div>
			</div>
			<form action="/exp2/" method="post" class="form-horizontal" id="form1">
			{% csrf_token %}
			<div class="form-group text-center">
				<table class="table table-condensed">
					<tbody>
						<tr>
							<td>Happy</td>
							<td><input type="radio" name="happy1" value="1" id="happy1"></td>
							<td><input type="radio" name="happy1" value="2" id="happy1"></td>
							<td><input type="radio" name="happy1" value="3" id="happy1"></td>
							<td><input type="radio" name="happy1" value="4" id="happy1"></td>
							<td><input type="radio" name="happy1" value="5" id="happy1"></td>
							<td><input type="radio" name="happy1" value="6" id="happy1"></td>
							<td><input type="radio" name="happy1" value="7" id="happy1"></td>
						</tr>
						<tr>
							<td>Sad</td>
							<td><input type="radio" name="sad1" value="1" id="sad1"></td>
							<td><input type="radio" name="sad1" value="2" id="sad1"></td>
							<td><input type="radio" name="sad1" value="3" id="sad1"></td>
							<td><input type="radio" name="sad1" value="4" id="sad1"></td>
							<td><input type="radio" name="sad1" value="5" id="sad1"></td>
							<td><input type="radio" name="sad1" value="6" id="sad1"></td>
							<td><input type="radio" name="sad1" value="7" id="sad1"></td>
							
						</tr>
						<tr>
							<td>Fearful</td>
							<td><input type="radio" name="fearful1" value="1" id="fearful1"></td>
							<td><input type="radio" name="fearful1" value="2" id="fearful1"></td>
							<td><input type="radio" name="fearful1" value="3" id="fearful1"></td>
							<td><input type="radio" name="fearful1" value="4" id="fearful1"></td>
							<td><input type="radio" name="fearful1" value="5" id="fearful1"></td>
							<td><input type="radio" name="fearful1" value="6" id="fearful1"></td>
							<td><input type="radio" name="fearful1" value="7" id="fearful1"></td>
							
						</tr>
						<tr>
							<td>Angry</td>
							<td><input type="radio" name="angry1" value="1" id="angry1"></td>
							<td><input type="radio" name="angry1" value="2" id="angry1"></td>
							<td><input type="radio" name="angry1" value="3" id="angry1"></td>
							<td><input type="radio" name="angry1" value="4" id="angry1"></td>
							<td><input type="radio" name="angry1" value="5" id="angry1"></td>
							<td><input type="radio" name="angry1" value="6" id="angry1"></td>
							<td><input type="radio" name="angry1" value="7" id="angry1"></td>						
						</tr>
						<tr>
							<td>Surprised</td>
							<td><input type="radio" name="surprised1" value="1" id="surprised1"></td>
							<td><input type="radio" name="surprised1" value="2" id="surprised1"></td>
							<td><input type="radio" name="surprised1" value="3" id="surprised1"></td>
							<td><input type="radio" name="surprised1" value="4" id="surprised1"></td>
							<td><input type="radio" name="surprised1" value="5" id="surprised1"></td>
							<td><input type="radio" name="surprised1" value="6" id="surprised1"></td>
							<td><input type="radio" name="surprised1" value="7" id="surprised1"></td>
							
						</tr>
					</tbody>
				</table>
			</div>
			<input type="hidden" name="expid" value="{{ expid }}" id ="expid">			
			<input type="hidden" name="Name" value="{{ name }}" id="name">
			<input type="hidden" name="RollNo" value="{{ roll }}" id="roll">
			<input type="hidden" name="Age" value="{{ age }}" id="age">
			<input type="hidden" name="Gender" value="{{ gender }}" id="gender">

			</div>
			<div class="form-group text-center">
				<div>
					<button type="submit" class="btn btn-default" id="button1">Submit</button>
				</div>
	</div>
	</form>
	</div>

<div id="pop2">
	<div class="container text-center">
			<h3>{{ question }}</h3>
			<div class="row">
	  			<div class="col-xs-3"></div>
	  			<div class="col-xs-1">Not at all</div>
	  			<div class="col-xs-3"></div>
	  			<div class="col-xs-1">Maybe</div>
	  			<div class="col-xs-3"></div>
	  			<div class="col-xs-1">Dominant emotion</div>
			</div>
			<form action="/exp2/" method="post" class="form-horizontal" id="form2">
			{% csrf_token %}
			<div class="form-group text-center">
				<table class="table table-condensed">
					<tbody>
						<tr>
							<td>Happy</td>
							<td><input type="radio" name="happy2" value="1" id="happy2"></td>
							<td><input type="radio" name="happy2" value="2" id="happy2"></td>
							<td><input type="radio" name="happy2" value="3" id="happy2"></td>
							<td><input type="radio" name="happy2" value="4" id="happy2"></td>
							<td><input type="radio" name="happy2" value="5" id="happy2"></td>
							<td><input type="radio" name="happy2" value="6" id="happy2"></td>
							<td><input type="radio" name="happy2" value="7" id="happy2"></td>
						</tr>
						<tr>
							<td>Sad</td>
							<td><input type="radio" name="sad2" value="1" id="sad2"></td>
							<td><input type="radio" name="sad2" value="2" id="sad2"></td>
							<td><input type="radio" name="sad2" value="3" id="sad2"></td>
							<td><input type="radio" name="sad2" value="4" id="sad2"></td>
							<td><input type="radio" name="sad2" value="5" id="sad2"></td>
							<td><input type="radio" name="sad2" value="6" id="sad2"></td>
							<td><input type="radio" name="sad2" value="7" id="sad2"></td>
						</tr>
						<tr>
							<td>Fearful</td>
							<td><input type="radio" name="fearful2" value="1" id="fearful2"></td>
							<td><input type="radio" name="fearful2" value="2" id="fearful2"></td>
							<td><input type="radio" name="fearful2" value="3" id="fearful2"></td>
							<td><input type="radio" name="fearful2" value="4" id="fearful2"></td>
							<td><input type="radio" name="fearful2" value="5" id="fearful2"></td>
							<td><input type="radio" name="fearful2" value="6" id="fearful2"></td>
							<td><input type="radio" name="fearful2" value="7" id="fearful2"></td>
						</tr>
						<tr>
							<td>Angry</td>
							<td><input type="radio" name="angry2" value="1" id="angry2"></td>
							<td><input type="radio" name="angry2" value="2" id="angry2"></td>
							<td><input type="radio" name="angry2" value="3" id="angry2"></td>
							<td><input type="radio" name="angry2" value="4" id="angry2"></td>
							<td><input type="radio" name="angry2" value="5" id="angry2"></td>
							<td><input type="radio" name="angry2" value="6" id="angry2"></td>
							<td><input type="radio" name="angry2" value="7" id="angry2"></td>
						</tr>
						<tr>
							<td>Surprised</td>
							<td><input type="radio" name="surprised2" value="1" id="surprised2"></td>
							<td><input type="radio" name="surprised2" value="2" id="surprised2"></td>
							<td><input type="radio" name="surprised2" value="3" id="surprised2"></td>
							<td><input type="radio" name="surprised2" value="4" id="surprised2"></td>
							<td><input type="radio" name="surprised2" value="5" id="surprised2"></td>
							<td><input type="radio" name="surprised2" value="6" id="surprised2"></td>
							<td><input type="radio" name="surprised2" value="7" id="surprised2"></td>
						</tr>
					</tbody>
				</table>
			</div>
			<input type="hidden" name="expid" value="{{ expid }}">
			<input type="hidden" name="Name" value="{{ name }}">
			<input type="hidden" name="RollNo" value="{{ roll }}">
			<input type="hidden" name="Age" value="{{ age }}">
			<input type="hidden" name="Gender" value="{{ gender }}">
			</div>
	<div class="form-group text-center">
				<div>
					<button type="submit" class="btn btn-default" id="button2">Submit</button>
				</div>
	</div>
	</form>
	</div>

	<div id="pop3">
	<div class="container text-center">
			<h3>{{ question }}</h3>
			<div class="row">
	  			<div class="col-xs-3"></div>
	  			<div class="col-xs-1">Not at all</div>
	  			<div class="col-xs-3"></div>
	  			<div class="col-xs-1">Maybe</div>
	  			<div class="col-xs-3"></div>
	  			<div class="col-xs-1">Dominant emotion</div>
			</div>
			<div class="form-group text-center">
				<table class="table table-condensed">
					<tbody>
						<tr>
							<td>Happy</td>
							<td><input type="radio" name="happy3" value="1"></td>
							<td><input type="radio" name="happy3" value="2"></td>
							<td><input type="radio" name="happy3" value="3"></td>
							<td><input type="radio" name="happy3" value="4"></td>
							<td><input type="radio" name="happy3" value="5"></td>
							<td><input type="radio" name="happy3" value="6"></td>
							<td><input type="radio" name="happy3" value="7"></td>
						</tr>
						<tr>
							<td>Sad</td>
							<td><input type="radio" name="sad3" value="1"></td>
							<td><input type="radio" name="sad3" value="2"></td>
							<td><input type="radio" name="sad3" value="3"></td>
							<td><input type="radio" name="sad3" value="4"></td>
							<td><input type="radio" name="sad3" value="5"></td>
							<td><input type="radio" name="sad3" value="6"></td>
							<td><input type="radio" name="sad3" value="7"></td>
						</tr>
						<tr>
							<td>Fearful</td>
							<td><input type="radio" name="fearful3" value="1"></td>
							<td><input type="radio" name="fearful3" value="2"></td>
							<td><input type="radio" name="fearful3" value="3"></td>
							<td><input type="radio" name="fearful3" value="4"></td>
							<td><input type="radio" name="fearful3" value="5"></td>
							<td><input type="radio" name="fearful3" value="6"></td>
							<td><input type="radio" name="fearful3" value="7"></td>
						</tr>
						<tr>
							<td>Angry</td>
							<td><input type="radio" name="angry3" value="1"></td>
							<td><input type="radio" name="angry3" value="2"></td>
							<td><input type="radio" name="angry3" value="3"></td>
							<td><input type="radio" name="angry3" value="4"></td>
							<td><input type="radio" name="angry3" value="5"></td>
							<td><input type="radio" name="angry3" value="6"></td>
							<td><input type="radio" name="angry3" value="7"></td>
						</tr>
						<tr>
							<td>Surprised</td>
							<td><input type="radio" name="surprised3" value="1"></td>
							<td><input type="radio" name="surprised3" value="2"></td>
							<td><input type="radio" name="surprised3" value="3"></td>
							<td><input type="radio" name="surprised3" value="4"></td>
							<td><input type="radio" name="surprised3" value="5"></td>
							<td><input type="radio" name="surprised3" value="6"></td>
							<td><input type="radio" name="surprised3" value="7"></td>
						</tr>
					</tbody>
				</table>
			</div>
			<input type="hidden" name="expid" value="{{ expid }}">
			<input type="hidden" name="Name" value="{{ name }}">
			<input type="hidden" name="RollNo" value="{{ roll }}">
			<input type="hidden" name="Age" value="{{ age }}">
			<input type="hidden" name="Gender" value="{{ gender }}">

			</div>
	<form action="/expNext/" method="post" class="form-horizontal" id="form3">
	{% csrf_token %}
		
		<div class="form-group text-center">
			<div>
				<button type="submit" class="btn btn-default" id="button3">Submit</button>
			<input type="hidden" name="expid" value="{{ expid }}">				
			</div>
		</div>
	</form>
	</div>
	
	

</body>
</html>